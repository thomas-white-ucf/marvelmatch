<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Super Survey</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <!-- MAIN CONTAINER -->
  <div class="container">

    <div class="jumbotron">
      <h1 class="text-center">
        <span class="fa fa-fire"></span>Marvel Match</h1>
      <hr>
      <h2 class="text-center">Supers Survey</h2>
      <br>
      <div class="text-center">
        <a href="api/friends">
          <button class="btn btn-lg btn-primary">
            <span class="fa fa-list-alt"></span>View Characters</button>
        </a>
        <a href="/">
          <button class="btn btn-lg btn-default">
            <span class="fa fa-home">Home Page</span>
          </button>
        </a>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">

        <!-- Character Entry Form (page) -->
        <div class="card">

          <div class="card-header">
            Character Survey
          </div>

          <div class="card-body">

                <h4>Character Name</h4>
                <input type="text" id="new-name" class="form-control" required>

                <h3>Question 1 </h3>
                <h2>Do you fly?</h2>
                <select class="chosen-select" id="q1">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select>
                <h3>Question 2 </h3>
                <h2>Do you swim?</h2>
                <select class="chosen-select" id="q2">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select> 
                <h3>Question 3 </h3>
                <h2>Do you jump?</h2>
                <select class="chosen-select" id="q3">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select> 
                <h3>Question 4 </h3>
                <h2>Do you run?</h2>
                <select class="chosen-select" id="q4">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select> 
                <h3>Question 5 </h3>
                <h2>Do you have psychic powers?</h2>
                <select class="chosen-select" id="q5">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Yeet</option>
                </select> 
                <h3>Question 6 </h3>
                <h2>Are you poisionous?</h2>
                <select class="chosen-select" id="q6">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select> 
                <h3>Question 7 </h3>
                <h2>Molecular Acceleration?</h2>
                <select class="chosen-select" id="q7">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select> 
                <h3>Question 8 </h3>
                <h2>Can you manipulate weather?</h2>
                <select class="chosen-select" id="q8">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select> 
                <h3>Question 9 </h3>
                <h2>Are you a Shapeshifter?</h2>
                <select class="chosen-select" id="q9">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select>  
                <h3>Question 10 </h3>
                <h2>Any Healing Factors?</h2>
                <select class="chosen-select" id="q10">
                        <option value></option>
                        <option value="1">No</option>
                        <option value="2">Don't think so</option>
                        <option value="3">Kinda</option>
                        <option value="4">Yes</option>
                        <option value="5">Fast</option>
                </select>  

            <br>
                <hr>
            </br>
            <button type="submit" class="btn btn-primary submit">
                  Submit
            </button>

            </form>
          </div>
        </div>
      </div>
    </div>


    <footer class="footer">
      <div class="container">
        <p>
          <a href="/api/friends">API Characters Link</a> |
          <a href="/home">home</a>
      </div>
    </footer>

  </div>

  <!-- MODAL -->
  <div id="results-modal" class="modal fade" role="dialog">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">X</button>
                    <h2 class="modal-title">
                        <strong>Supers Match!</strong>
                    </h2>
              </div>
              <div class="modal-body">
                    <h2 id="match-name"></h2>
                    <!-- Add image -->
              </div>
              <div class="modal-footer">
                    <button class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
        </div>
      </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <!-- Chosen -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js"></script>

<!-- ====================================================================== -->
<!-- BELOW CODE IS CRITICAL. IT HANDLES HOW FORM DATA IS SENT TO OUR SERVER -->

  <script type="text/javascript">

    // CSS
    var config = {
            ".chosen-select": {},
            ".chosen-select-deselect": {
                allow_single_deselect: true
            },
            ".chosen-select-no-single": {
                disable_search_threshold: 10
            },
            ".chosen-select-no-results": {
                no_results_text: "nothing found!"
            },
            ".chosen-select-width": {
                width: "95%"
            }
        };

    for (var selector in config) {
            $(selector).chosen(config[selector]);
    }

    // * In this code below we create the Front-end JavaScript which "POSTS" our form data to our express server.
    // In essence, when the user hits submit, jQuery grabs all of the fields then sends a post request to our api
    // Our api recognizes the route (/api/friends)... and then runs the associated code (here or move back to >> apiRoutes.js).
    // In this case the associated code "saves" the data to the friends.js file


        // * Validate form was filled out correctly
        function validateForm() {
            var isValid = true;
            $(".form-control").each(function() {
                if ($(this).val() === "") {
                    isValid = false;
                }
            });

            $(".chosen-select").each(function() {
                if ($(this).val() === "") {
                    isValid = false;
                }
            });
            return isValid;
        }

        // called in runMarvelQuery, after form submit
        function displayModal(match) {

          console.log("displayModal(match)  >>>>>> ___+ match =", match)

          $("#match-name").text(match.name);
          $("#results-modal").modal("toggle");
        }

        // Clear the form when submitting
        function clearForm() {
            $("#new-name").val("");
            $("#q1").val(""); 
            $("#q2").val(""); 
            $("#q3").val(""); 
            $("#q4").val("");
            $("#q5").val(""); 
            $("#q6").val("");
            $("#q7").val("");
            $("#q8").val("");
            $("#q9").val("");
            $("#q10").val("");
    }

        // AFTER BUTTON CLICK => 
        //                  runMarvelQuery > then > displayModal(match)
        function runMarvelQuery() {

              // The AJAX function uses the URL of our API to GET the match associated with it (initially set to localhost)
              $.ajax({ url: "/api/friends", method: "GET" })
                .then(function(friends) {
                          // Here we then log the friends to console
                          // friends will display as object
                          // console.log("ajax GET request > friend = ", friends);
                          // console.log("------------------------------------");

                          // DETERMINE BEST MATCH

                              // largest possible question point difference is less than 50
                              let test = 50;
                              let recentAddIndex = (friends.length - 1)
                              console.log("added index = ", recentAddIndex)

                              // .. loop through friends, compare each i for friends items
                              // Absolute value difference, save each, replace if it is lower,
                              // save that friends place in variable,
                              // display this in modal pop up
                              //  ENDING J at  ( - 1 )   -  so it does not compare to last added friend

                              let match;

                              // Determine which character is best match to current form entry (friends)  -  j
                              for (let j = 0; j < recentAddIndex; j++) {

                                    // reset difference and resultrs for each j loop
                                    let difference = 0;
                                    let result = 0;

                                    console.log('new loop test > low match number to beat > test = ', test);
                                    console.log('---- --- ---- --- -- --- ');

                                    // Get Best Match
                                    //  - least difference between current entry and list of characters  -  i
                                    for (let i = 0; i < 9; i++) {
                                          difference = Math.abs(friends[j].scores[i] - friends[recentAddIndex].scores[i]);
                                          result += difference;
                                    }     

                                    // capture friend match index j if result is less than the current test
                                    if ((result < test)) {  
                                          // match is result j index
                                          match = friends[j];
                                          
                                          // set new test to result that was lower than current test
                                          test = result;

                                          console.log('found lower number difference for =>   result = ', result);
                                          console.log('match = ', match);

                                    } else if( (recentAddIndex - 1)  === j ) {

                                          // IF ON LAST LOOP - return the best match 
                                          // console.log('last loop. j === (friends.length -1) == match => ', match);
                                          console.log("else if > last loop > call function DISPLAYMODAL(match)")
                                          displayModal(match)

                                    }
        
                                } // END for loop j
                    }); // END $.ajax
          }

        //   ON - SUBMIT - CLICK   > ≥ +++++  validate form data  > ≥ +++++    then runMarvelQuery
        $(".submit").on("click", function(event) {
          event.preventDefault();

          // If form is Valid on submit this will be true
          //    GRAB form data > POST newCharacter to friends array with that info
          if (validateForm()) {

                  // Grab info from form to Create new character
                  var newCharacter = {
                      name: $("#new-name").val().trim(),
                      scores: [
                            $("#q1").val(),
                            $("#q2").val(),
                            $("#q3").val(),
                            $("#q4").val(),
                            $("#q5").val(),
                            $("#q6").val(),
                            $("#q7").val(),
                            $("#q8").val(),
                            $("#q9").val(),
                            $("#q10").val()
                        ]
                  };

                  // console log new character variable > contructed with form info
                  console.log("survey JS > > newCharacter = ", newCharacter);
              
                  // =
                  //  POST
                  // THIS LINE IS THE MAGIC. It"s very similar to the standard ajax function we used.
                      // * adds User data to friends array
                      // Essentially we give it a URL, we give it the object we want to send (newCharacter), then we have a "callback" ( function(data) ).
                      // The callback is the response of the server. In our case, we set up code in api-routes that "returns" true or false
                      // POST was able to be successfully completed, 
                      //    >  logic was performed on server side in >>  apiRoutes.js file
                      //    >  returns true or false depending on friends logic 
                  //  POST

                  // call runMarvelQuery if data = true
                  $.post("/api/friends", newCharacter, function(data) {
                  
                          // Able to use data here
                          console.log("survey JS > > data ========== ", data)

                          // runMarvelQuery to test on button click after newCharacter is posted
                          if (data) {
                            runMarvelQuery();
                            clearForm(); 
                            console.log("called functions runMarvelQuery() and clearForm")
                          } 
                          else {
                            // end if(data) if statement
                            alert("survey logic fail - if statement")
                          }
                  }); 
                  // end POST - $.post > /api/friends > newCharacter > > >  callback function(data)
              } // ELSE - IF THE FORM IS NOT VALID 
                else {
                  alert("Please Complete the Supers Survey to Match with a Character")
                };
          });
        
  </script>

</body>

</html>


  <!-- // In this code, jQuery is used to "download" the match from our server 
  // We then dynamically display this content in our table. This is very similar to the group projects you just completed.
  // It's also very similar to the NYT search application. In fact, I copied a ton of code from there.